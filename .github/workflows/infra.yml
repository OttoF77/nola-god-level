# GitHub Actions: Provisionar infraestrutura Azure via Bicep
# Trigger: manual (workflow_dispatch) ou push em infra/

name: Azure Infrastructure

on:
  workflow_dispatch: # ExecuÃ§Ã£o manual
    inputs:
      environment:
        description: 'Ambiente (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
  push:
    branches:
      - main
    paths:
      - 'infra/**'

env:
  AZURE_RESOURCE_GROUP: nola-rg
  AZURE_LOCATION: eastus

jobs:
  provision:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Login no Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Criar Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }} \
            --tags project=nola environment=${{ github.event.inputs.environment || 'dev' }}

      - name: Deploy Bicep
        uses: azure/arm-deploy@v1
        with:
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: infra/main.bicep
          parameters: >
            projectName=nola
            environment=${{ github.event.inputs.environment || 'dev' }}
            location=${{ env.AZURE_LOCATION }}
            postgresAdminPassword=${{ secrets.POSTGRES_ADMIN_PASSWORD }}
          failOnStdErr: false

      - name: Obter outputs
        id: bicep-outputs
        run: |
          OUTPUTS=$(az deployment group show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name main \
            --query properties.outputs \
            --output json)
          
          echo "acrLoginServer=$(echo $OUTPUTS | jq -r '.acrLoginServer.value')" >> $GITHUB_OUTPUT
          echo "postgresHost=$(echo $OUTPUTS | jq -r '.postgresHost.value')" >> $GITHUB_OUTPUT
          echo "backendUrl=$(echo $OUTPUTS | jq -r '.backendUrl.value')" >> $GITHUB_OUTPUT
          echo "frontendUrl=$(echo $OUTPUTS | jq -r '.frontendUrl.value')" >> $GITHUB_OUTPUT

      - name: Exibir URLs
        run: |
          echo "ðŸ”— ACR: ${{ steps.bicep-outputs.outputs.acrLoginServer }}"
          echo "ðŸ”— PostgreSQL: ${{ steps.bicep-outputs.outputs.postgresHost }}"
          echo "ðŸ”— Backend: https://${{ steps.bicep-outputs.outputs.backendUrl }}"
          echo "ðŸ”— Frontend: https://${{ steps.bicep-outputs.outputs.frontendUrl }}"

      - name: Logout Azure
        run: az logout
        if: always()

# GitHub Actions: Build e Deploy Frontend (Static Web Apps)
# Trigger: push em frontend/ ou manual

name: Frontend Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      api_base_url:
        description: 'API base URL para a build (ex.: https://<backend-fqdn>)'
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      - 'frontend/**'

env:
  AZURE_RESOURCE_GROUP: nola-rg
  PROJECT_NAME: nola

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar depend√™ncias
        working-directory: frontend
        run: npm ci

      - name: Resolver API base URL
        id: resolve_api
        env:
          INPUT_API_BASE_URL: ${{ github.event.inputs.api_base_url }}
          SECRET_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        run: |
          if [ -n "$INPUT_API_BASE_URL" ]; then
            echo "CHOSEN_API_BASE=$INPUT_API_BASE_URL" >> $GITHUB_ENV
            echo "api_chosen=true" >> $GITHUB_OUTPUT
            echo "Usando api_base_url do dispatch: $INPUT_API_BASE_URL"
            exit 0
          fi
          if [ -n "$SECRET_API_BASE_URL" ]; then
            echo "CHOSEN_API_BASE=$SECRET_API_BASE_URL" >> $GITHUB_ENV
            echo "api_chosen=true" >> $GITHUB_OUTPUT
            echo "Usando VITE_API_BASE_URL de secret"
            exit 0
          fi
          if [ -f frontend/.api_base_url ]; then
            REF=$(cat frontend/.api_base_url | tr -d '\n' | tr -d '\r')
            if [ -n "$REF" ]; then
              echo "CHOSEN_API_BASE=$REF" >> $GITHUB_ENV
              echo "api_chosen=true" >> $GITHUB_OUTPUT
              echo "Usando frontend/.api_base_url: $REF"
              exit 0
            fi
          fi
          echo "api_chosen=false" >> $GITHUB_OUTPUT
          echo "Nenhuma API base URL fornecida; a build pode usar http://localhost:8000 e falhar em produ√ß√£o por CSP."

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_API_BASE_URL: ${{ env.CHOSEN_API_BASE }}
        run: npm run build

      - name: Validar secrets necess√°rios
        run: |
          if [ -z "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" ]; then
            echo "Erro: Secret AZURE_STATIC_WEB_APPS_API_TOKEN n√£o est√° definido no reposit√≥rio."
            echo "Acesse Azure Static Web Apps > Deployment tokens e adicione o token em Settings > Secrets and variables > Actions."
            exit 1
          fi
          if [ "${{ steps.resolve_api.outputs.api_chosen }}" != "true" ]; then
            echo "Aviso: Nenhum VITE_API_BASE_URL fornecido (dispatch/secret/arquivo). O frontend pode referenciar http://localhost:8000 e ser bloqueado pela CSP."
          fi

      - name: Harden CSP (alinha connect-src com a API)
        if: always()
        run: |
          DIST_FILE=frontend/dist/index.html
          if [ -f "$DIST_FILE" ]; then
            echo "Antes:" && grep -n "Content-Security-Policy" "$DIST_FILE" || true
            sed -i.bak "s# http://localhost:8000##g" "$DIST_FILE"
            # Se CHOSEN_API_BASE estiver definido, injeta a origem no connect-src
            if [ -n "${CHOSEN_API_BASE}" ]; then
              ORIGIN=$(echo "${CHOSEN_API_BASE}" | sed -E 's#^([A-Za-z][A-Za-z0-9+.-]*://[^/]+).*$#\1#')
              if [ -n "$ORIGIN" ]; then
                # adiciona $ORIGIN se n√£o existir ainda
                if ! grep -q "$ORIGIN" "$DIST_FILE"; then
                  sed -i.bak "s#connect-src 'self'#connect-src 'self' $ORIGIN#g" "$DIST_FILE"
                fi
              fi
            fi
            echo "Depois:" && grep -n "Content-Security-Policy" "$DIST_FILE" || true
          else
            echo "Arquivo $DIST_FILE n√£o encontrado; pulando hardening de CSP."
          fi

      - name: Deploy no Azure Static Web Apps
        id: swa_deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'frontend'
          output_location: 'dist'
          skip_api_build: true
      
      - name: Exibir URL real do frontend
        run: |
          echo "üöÄ Frontend deployado!"
          if [ -n "${{ steps.swa_deploy.outputs.static_web_app_url }}" ]; then
            echo "üîó URL: ${{ steps.swa_deploy.outputs.static_web_app_url }}"
          elif [ -n "${{ steps.swa_deploy.outputs.environment_url }}" ]; then
            echo "ÔøΩ URL: ${{ steps.swa_deploy.outputs.environment_url }}"
          else
            echo "‚ÑπÔ∏è A URL n√£o foi retornada como output. Veja o log do passo 'Deploy no Azure Static Web Apps' para a URL impressa pelo Action ou confira no Portal do Azure."
          fi

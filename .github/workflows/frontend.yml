# GitHub Actions: Build e Deploy Frontend (Static Web Apps)
# Trigger: push em frontend/ ou manual

name: Frontend Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
  push:
    branches:
      - main
    paths:
      - 'frontend/**'

env:
  AZURE_RESOURCE_GROUP: nola-rg
  PROJECT_NAME: nola

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar dependÃªncias
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        run: npm run build

      - name: Validar secrets necessÃ¡rios
        run: |
          if [ -z "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" ]; then
            echo "Erro: Secret AZURE_STATIC_WEB_APPS_API_TOKEN nÃ£o estÃ¡ definido no repositÃ³rio."
            echo "Acesse Azure Static Web Apps > Deployment tokens e adicione o token em Settings > Secrets and variables > Actions."
            exit 1
          fi
          if [ -z "${{ secrets.VITE_API_BASE_URL }}" ]; then
            echo "Aviso: Secret VITE_API_BASE_URL nÃ£o estÃ¡ definido. O frontend usarÃ¡ http://localhost:8000 por padrÃ£o, que pode ser bloqueado pela CSP."
          fi

      - name: Harden CSP (remove localhost de connect-src na build)
        if: always()
        run: |
          DIST_FILE=frontend/dist/index.html
          if [ -f "$DIST_FILE" ]; then
            echo "Antes:" && grep -n "Content-Security-Policy" "$DIST_FILE" || true
            sed -i.bak "s# http://localhost:8000##g" "$DIST_FILE"
            echo "Depois:" && grep -n "Content-Security-Policy" "$DIST_FILE" || true
          else
            echo "Arquivo $DIST_FILE nÃ£o encontrado; pulando hardening de CSP."
          fi

      - name: Deploy no Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'frontend'
          output_location: 'dist'
          skip_api_build: true

      - name: Exibir URL do frontend
        run: |
          ENV_NAME=${{ github.event.inputs.environment || 'dev' }}
          SWA_NAME=${{ env.PROJECT_NAME }}-${ENV_NAME}-frontend
          
          echo "ðŸš€ Frontend deployado!"
          echo "ðŸ”— Acesse: https://${SWA_NAME}.azurestaticapps.net"

# GitHub Actions: Build e Deploy Frontend (Static Web Apps)
# Trigger: push em frontend/ ou manual

name: Frontend Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      api_base_url:
        description: 'API base URL para a build (ex.: https://<backend-fqdn>)'
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      - 'frontend/**'

env:
  AZURE_RESOURCE_GROUP: nola-rg
  PROJECT_NAME: nola

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar depend√™ncias
        working-directory: frontend
        run: npm ci

      - name: Resolver e aplicar API base URL
        id: resolve_api
        env:
          INPUT_API_BASE_URL: ${{ github.event.inputs.api_base_url }}
          SECRET_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        run: |
          # Resolver a URL da API (dispatch > secret > arquivo)
          API_URL=""
          
          if [ -n "$INPUT_API_BASE_URL" ]; then
            API_URL="$INPUT_API_BASE_URL"
            echo "‚úì Usando api_base_url do dispatch: $API_URL"
          elif [ -n "$SECRET_API_BASE_URL" ]; then
            API_URL="$SECRET_API_BASE_URL"
            echo "‚úì Usando VITE_API_BASE_URL de secret: $API_URL"
          elif [ -f frontend/.api_base_url ]; then
            API_URL=$(cat frontend/.api_base_url | tr -d '\n' | tr -d '\r' | tr -d ' ')
            if [ -n "$API_URL" ]; then
              echo "‚úì Usando frontend/.api_base_url: $API_URL"
            fi
          fi
          
          if [ -z "$API_URL" ]; then
            echo "‚ö† AVISO: Nenhuma API base URL fornecida!"
            echo "‚ö† O frontend vai usar http://localhost:8000 (padr√£o) e pode falhar em produ√ß√£o."
            echo "api_url=" >> $GITHUB_OUTPUT
            echo "api_chosen=false" >> $GITHUB_OUTPUT
          else
            echo "API_URL=$API_URL" >> $GITHUB_ENV
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
            echo "api_chosen=true" >> $GITHUB_OUTPUT
            echo "‚úì VITE_API_BASE_URL ser√°: $API_URL"
          fi

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_API_BASE_URL: ${{ steps.resolve_api.outputs.api_url }}
        run: |
          echo "Building com VITE_API_BASE_URL=$VITE_API_BASE_URL"
          if [ -z "$VITE_API_BASE_URL" ]; then
            echo "‚ö†Ô∏è ERRO: VITE_API_BASE_URL est√° vazio!"
            exit 1
          fi
          npm run build

      - name: Validar secrets necess√°rios
        run: |
          if [ -z "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" ]; then
            echo "Erro: Secret AZURE_STATIC_WEB_APPS_API_TOKEN n√£o est√° definido no reposit√≥rio."
            echo "Acesse Azure Static Web Apps > Deployment tokens e adicione o token em Settings > Secrets and variables > Actions."
            exit 1
          fi
          if [ "${{ steps.resolve_api.outputs.api_chosen }}" != "true" ]; then
            echo "Aviso: Nenhum VITE_API_BASE_URL fornecido (dispatch/secret/arquivo). O frontend pode referenciar http://localhost:8000 e ser bloqueado pela CSP."
          fi

      - name: Harden CSP (alinha connect-src com a API)
        if: always()
        run: |
          DIST_FILE=frontend/dist/index.html
          if [ -f "$DIST_FILE" ]; then
            echo "Antes:" && grep -n "Content-Security-Policy" "$DIST_FILE" || true
            sed -i.bak "s# http://localhost:8000##g" "$DIST_FILE"
            # Se CHOSEN_API_BASE estiver definido, injeta a origem no connect-src
            if [ -n "${CHOSEN_API_BASE}" ]; then
              ORIGIN=$(echo "${CHOSEN_API_BASE}" | sed -E 's#^([A-Za-z][A-Za-z0-9+.-]*://[^/]+).*$#\1#')
              if [ -n "$ORIGIN" ]; then
                # adiciona $ORIGIN se n√£o existir ainda
                if ! grep -q "$ORIGIN" "$DIST_FILE"; then
                  sed -i.bak "s#connect-src 'self'#connect-src 'self' $ORIGIN#g" "$DIST_FILE"
                fi
              fi
            fi
            echo "Depois:" && grep -n "Content-Security-Policy" "$DIST_FILE" || true
          else
            echo "Arquivo $DIST_FILE n√£o encontrado; pulando hardening de CSP."
          fi

      - name: Deploy no Azure Static Web Apps
        id: swa_deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'frontend'
          output_location: 'dist'
          skip_api_build: true
      
      - name: Exibir URL real do frontend
        run: |
          echo "üöÄ Frontend deployado!"
          if [ -n "${{ steps.swa_deploy.outputs.static_web_app_url }}" ]; then
            echo "üîó URL: ${{ steps.swa_deploy.outputs.static_web_app_url }}"
          elif [ -n "${{ steps.swa_deploy.outputs.environment_url }}" ]; then
            echo "ÔøΩ URL: ${{ steps.swa_deploy.outputs.environment_url }}"
          else
            echo "‚ÑπÔ∏è A URL n√£o foi retornada como output. Veja o log do passo 'Deploy no Azure Static Web Apps' para a URL impressa pelo Action ou confira no Portal do Azure."
          fi
